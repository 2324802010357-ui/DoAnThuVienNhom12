@model IEnumerable<DoAnThuVienNhom12.Models.Kho>

@{
    ViewBag.Title = "Quản lý kho sách";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .warehouse-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 20px;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        margin-bottom: 15px;
    }

        .stat-card h3 {
            margin: 0;
            font-size: 32px;
            font-weight: bold;
        }

        .stat-card p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }

    .warehouse-tabs {
        border-bottom: 2px solid #e0e0e0;
        margin-bottom: 20px;
    }

        .warehouse-tabs .nav-tabs {
            border-bottom: none;
        }

            .warehouse-tabs .nav-tabs > li > a {
                border-radius: 8px 8px 0 0;
                margin-right: 5px;
            }

            .warehouse-tabs .nav-tabs > li.active > a {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
            }

    .progress-bar-success {
        background: #2ecc71;
    }

    .progress-bar-warning {
        background: #f39c12;
    }

    .progress-bar-danger {
        background: #e74c3c;
    }
</style>

<div class="animate-fade-in">
    <div class="page-header">
        <h2><i class="fa fa-warehouse"></i> Quản lý kho sách</h2>
        <p class="lead">Quản lý tồn kho, nhập sách và theo dõi số lượng</p>
    </div>

    <!-- Thống kê -->
    <div class="row">
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                <h3>@Model.Sum(k => k.SoLuongHienTai)</h3>
                <p>Tổng sách trong kho</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #27ae60, #2ecc71);">
                <h3>@Model.Count()</h3>
                <p>Tổng số kho</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                <h3>@Model.Sum(k => k.KeSaches.Count())</h3>
                <p>Tổng số kệ</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                <h3>@Model.Count(k => k.TrangThai == "Bảo trì")</h3>
                <p>Kho đang bảo trì</p>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="warehouse-tabs">
        <ul class="nav nav-tabs" role="tablist">
            <li class="active">
                <a href="#inventory" role="tab" data-toggle="tab">
                    <i class="fa fa-boxes"></i> Danh sách kho
                </a>
            </li>
            <li>
                <a href="#import" role="tab" data-toggle="tab">
                    <i class="fa fa-file-import"></i> Phiếu nhập
                </a>
            </li>
            <li>
                <a href="#history" role="tab" data-toggle="tab">
                    <i class="fa fa-history"></i> Lịch sử
                </a>
            </li>
        </ul>
    </div>

    <div class="tab-content">
        <!-- Tab 1: Danh sách kho -->
        <div class="tab-pane active" id="inventory">
            <div class="warehouse-card">
                <div class="text-right" style="margin-bottom:15px;">
                    <button class="btn btn-success" data-toggle="modal" data-target="#addWarehouseModal">
                        <i class="fa fa-plus"></i> Thêm kho mới
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead>
                            <tr class="active">
                                <th>Mã kho</th>
                                <th>Tên kho</th>
                                <th>Địa chỉ</th>
                                <th>Mô tả</th>
                                <th>Sức chứa</th>
                                <th>Hiện tại</th>
                                <th>Trạng thái</th>
                                <th>Số kệ</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var kho in Model)
                            {
                                var percent = kho.SucChua == 0 ? 0 : (int)((double)kho.SoLuongHienTai / kho.SucChua * 100);
                                var barColor = percent > 90 ? "danger" :
                                               percent > 70 ? "warning" : "success";

                                <tr data-id="@kho.MaKho">
                                    <td>@kho.MaKho</td>
                                    <td><strong>@kho.TenKho</strong></td>
                                    <td>@kho.DiaChi</td>
                                    <td>@kho.MoTa</td>
                                    <td class="text-center">@kho.SucChua</td>
                                    <td class="text-center">
                                        @kho.SoLuongHienTai
                                        <div class="progress" style="height:8px; margin-top:3px;">
                                            <div class="progress-bar progress-bar-@barColor" style="width:@percent%"></div>
                                        </div>
                                    </td>
                                    <td>@kho.TrangThai</td>
                                    <td class="text-center">@kho.KeSaches.Count()</td>
                                    <td class="text-center">
                                        <a href="@Url.Action("ChiTiet", "Kho", new { id = kho.MaKho })" class="btn btn-xs btn-info" title="Chi tiết">
                                            <i class="fa fa-eye"></i>
                                        </a>
                                        <button class="btn btn-xs btn-warning btn-edit" title="Sửa"><i class="fa fa-edit"></i></button>
                                        <button class="btn btn-xs btn-danger btn-delete" title="Xóa"><i class="fa fa-trash"></i></button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab 2: Phiếu nhập -->
        <div class="tab-pane" id="import">
            <div class="warehouse-card text-center">
                <h4><i class="fa fa-file-import"></i> Chức năng nhập sách sẽ được kích hoạt sau khi liên kết bảng PhiếuNhapKho</h4>
                <p class="text-muted">Hiện tại chưa có dữ liệu thực tế từ CSDL.</p>
            </div>
        </div>

        <!-- Tab 3: Lịch sử -->
        <div class="tab-pane" id="history">
            <div class="warehouse-card text-center">
                <h4><i class="fa fa-history"></i> Lịch sử nhập kho đang được cập nhật...</h4>
                <p class="text-muted">Vui lòng kiểm tra sau khi tạo bảng PhiếuNhapKho.</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Thêm Kho -->
<div class="modal fade" id="addWarehouseModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;">
                <h4 class="modal-title"><i class="fa fa-plus"></i> Thêm kho mới</h4>
            </div>
            <div class="modal-body">
                <form id="addWarehouseForm">
                    <div class="form-group">
                        <label>Tên kho</label>
                        <input type="text" name="TenKho" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label>Địa chỉ</label>
                        <input type="text" name="DiaChi" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label>Mô tả</label>
                        <textarea name="MoTa" class="form-control"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Sức chứa</label>
                        <input type="number" name="SucChua" class="form-control" value="100" min="10" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" data-dismiss="modal">Hủy</button>
                <button class="btn btn-primary" id="btnSaveWarehouse"><i class="fa fa-save"></i> Lưu</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
    // === Thêm kho ===
    $('#btnSaveWarehouse').on('click', function(){
        var data = $('#addWarehouseForm').serialize();
        $.post('@Url.Action("ThemKho", "Kho")', data, function(res){
            alert(res.message);
            if(res.success) location.reload();
        });
    });

    // === Xóa kho ===
    $('.btn-delete').on('click', function(){
        var id = $(this).closest('tr').data('id');
        if(confirm("Bạn có chắc muốn xóa kho này?")){
            $.post('@Url.Action("XoaKho", "Kho")', { MaKho: id }, function(res){
                alert(res.message);
                if(res.success) location.reload();
            });
        }
    });

    // === Sửa kho ===
    $('.btn-edit').on('click', function(){
        var row = $(this).closest('tr');
        var id = row.data('id');
        var tenKho = prompt("Nhập tên kho mới:", row.find('td:nth-child(2)').text());
        if (!tenKho) return;

        var diaChi = row.find('td:nth-child(3)').text();
        var moTa = row.find('td:nth-child(4)').text();
        var sucChua = row.find('td:nth-child(5)').text();

        $.post('@Url.Action("SuaKho", "Kho")', {
            MaKho: id,
            TenKho: tenKho,
            DiaChi: diaChi,
            MoTa: moTa,
            SucChua: sucChua
        }, function(res){
            alert(res.message);
            if(res.success) location.reload();
        });
    });
    </script>
}
