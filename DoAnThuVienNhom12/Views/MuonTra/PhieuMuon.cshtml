@{
    ViewBag.Title = "Tạo Phiếu Mượn";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .ui-autocomplete {
        z-index: 3000 !important;
    }

    .table td {
        vertical-align: middle;
    }

    .info-box {
        background: #f9f9f9;
        border-radius: 8px;
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 10px;
    }
</style>

<div class="panel panel-default" style="margin-top:15px;">
    <div class="panel-heading"><strong><i class="glyphicon glyphicon-book"></i> Phiếu mượn</strong></div>
    <div class="panel-body">

        <!-- THÔNG TIN SINH VIÊN -->
        <div class="info-box">
            <h5><i class="glyphicon glyphicon-user"></i> Thông tin sinh viên</h5>

            <div class="form-horizontal">

                <div class="form-group">
                    <label class="col-sm-3 control-label">Tên sinh viên:</label>
                    <div class="col-sm-9">
                        <input id="pmStudentName" class="form-control">
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label">Mã sinh viên:</label>
                    <div class="col-sm-4">
                        <input id="pmStudentId" class="form-control">
                    </div>

                    <label class="col-sm-2 control-label">Mã lớp:</label>
                    <div class="col-sm-3">
                        <input id="pmClassId" class="form-control">
                    </div>
                </div>

                <div class="form-group">
                    <label class="col-sm-3 control-label">Ngày mượn:</label>
                    <div class="col-sm-4">
                        <input id="pmBorrowDate" type="date" class="form-control">
                    </div>

                    <label class="col-sm-2 control-label">Hạn trả:</label>
                    <div class="col-sm-3">
                        <input id="pmDueDate" type="date" class="form-control">
                    </div>
                </div>

            </div>
        </div>

        <hr />

        <!-- DANH SÁCH SÁCH -->
        <h5><i class="glyphicon glyphicon-list-alt"></i> Danh sách sách mượn</h5>

        <table class="table table-bordered" id="tblBorrow">
            <thead>
                <tr class="active">
                    <th style="width:40px;">STT</th>
                    <th style="width:100px;">Mã sách</th>
                    <th>Tên sách</th>
                    <th style="width:160px;">Tác giả</th>
                    <th style="width:160px;">NXB</th>
                    <th style="width:60px;">Xóa</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <button id="addBook" class="btn btn-sm btn-success">
            <i class="glyphicon glyphicon-plus"></i> Thêm sách
        </button>

        <div class="text-right" style="margin-top:15px;">
            <button id="btnPrint" class="btn btn-default">
                <i class="glyphicon glyphicon-print"></i> In phiếu
            </button>

            <button id="btnSave" class="btn btn-primary">
                <i class="glyphicon glyphicon-ok"></i> Xác nhận mượn
            </button>
        </div>
    </div>
</div>


@section Scripts {
    <script>
$(function () {

    // === AUTO SET DATE ===
    const today = new Date();
    $("#pmBorrowDate").val(today.toISOString().split("T")[0]);

    const due = new Date(today);
    due.setDate(today.getDate() + 14);
    $("#pmDueDate").val(due.toISOString().split("T")[0]);


    // === ADD BOOK ROW ===
    $("#addBook").click(function () {
        const idx = $("#tblBorrow tbody tr").length + 1;

        const tr = $(`
            <tr>
                <td class="text-center">${idx}</td>
                <td><input class="form-control code" type="number" min="1"></td>
                <td><input class="form-control title" readonly></td>
                <td><input class="form-control author" readonly></td>
                <td><input class="form-control publisher" readonly></td>
                <td class="text-center">
                    <button class="btn btn-danger btn-sm del"><i class="glyphicon glyphicon-trash"></i></button>
                </td>
            </tr>`);

        $("#tblBorrow tbody").append(tr);
    });

    // === DELETE ROW ===
    $("#tblBorrow").on("click", ".del", function () {
        $(this).closest("tr").remove();
        updateIndex();
    });

    function updateIndex() {
        $("#tblBorrow tbody tr").each(function (i) {
            $(this).find("td:first").text(i + 1);
        });
    }

    // === LOAD BOOK INFO ===
    $("#tblBorrow").on("change", ".code", function () {
        const code = $(this).val().trim();
        const row = $(this).closest("tr");
        if (!code) return;

        $.ajax({
            url: '@Url.Action("LayThongTinSach","MuonTra")',
            type: "GET",
            data: { maSach: code },
            success: function (data) {

                if (!data || data.success === false) {
                    alert("❌ Không tìm thấy sách!");
                    row.find(".title, .author, .publisher").val("");
                    return;
                }

                row.find(".title").val(data.title);
                row.find(".author").val(data.author);
                row.find(".publisher").val(data.publisher);
            },
            error: function () {
                alert("❌ Lỗi API! Kiểm tra Controller.");
            }
        });

    });


    // ============================
    // 💾 SAVE PHIẾU MƯỢN
    // ============================
    $("#btnSave").click(function () {

        const books = [];
        $("#tblBorrow tbody tr").each(function () {
            const code = $(this).find(".code").val();
            if (code) books.push(code);
        });

        const payload = {
            studentName: $("#pmStudentName").val(),
            studentId: $("#pmStudentId").val(),
            classId: $("#pmClassId").val(),
            borrowDate: $("#pmBorrowDate").val(),
            dueDate: $("#pmDueDate").val(),
            books: books
        };

        if (!payload.studentName || !payload.studentId || !payload.classId) {
            alert("⚠ Nhập đầy đủ thông tin sinh viên!");
            return;
        }

        if (books.length === 0) {
            alert("⚠ Chưa chọn sách!");
            return;
        }

        $.ajax({
            url: '@Url.Action("SavePhieuMuon","MuonTra")',
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(payload),
            success: function (res) {
                alert(res.message);
                if (res.success)
                    window.location.href = '@Url.Action("Index","MuonTra")';
            },
            error: function () { alert("❌ Lỗi lưu phiếu mượn!"); }
        });
    });



    // ============================
    // 🖨 IN PHIẾU MƯỢN (ĐÃ FIX FULL)
    // ============================
    $("#btnPrint").click(function () {

        let win = window.open("", "_blank", "width=900,height=700");

        let html = `
            <html>
            <head>
                <title>PHIẾU MƯỢN SÁCH</title>
                <style>
                    body { font-family: Arial; padding: 20px; }
                    h2 { text-align: center; margin-bottom: 20px; }
                    table { width:100%; border-collapse: collapse; margin-top:10px; }
                    table, th, td { border:1px solid #000; }
                    th, td { padding:7px; text-align:left; }
                </style>
            </head>

            <body>
                <h2>PHIẾU MƯỢN SÁCH</h2>

                <p><strong>Họ tên:</strong> ${$("#pmStudentName").val()}</p>
                <p><strong>MSSV:</strong> ${$("#pmStudentId").val()}</p>
                <p><strong>Lớp:</strong> ${$("#pmClassId").val()}</p>
                <p><strong>Ngày mượn:</strong> ${$("#pmBorrowDate").val()}</p>
                <p><strong>Hạn trả:</strong> ${$("#pmDueDate").val()}</p>

                <h4>Danh sách sách mượn:</h4>

                <table>
                    <tr>
                        <th>STT</th>
                        <th>Mã sách</th>
                        <th>Tên sách</th>
                        <th>Tác giả</th>
                        <th>NXB</th>
                    </tr>
        `;

        $("#tblBorrow tbody tr").each(function (i) {
            html += `
                <tr>
                    <td>${i + 1}</td>
                    <td>${$(this).find(".code").val()}</td>
                    <td>${$(this).find(".title").val()}</td>
                    <td>${$(this).find(".author").val()}</td>
                    <td>${$(this).find(".publisher").val()}</td>
                </tr>
            `;
        });

        html += `
                </table>
            </body>
            </html>
        `;

        win.document.write(html);
        win.document.close();
        win.print();
    });

});
    </script>
}

