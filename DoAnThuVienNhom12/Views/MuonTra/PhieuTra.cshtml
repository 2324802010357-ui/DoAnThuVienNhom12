@{
    ViewBag.Title = "Tạo Phiếu Trả";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .ui-autocomplete {
        z-index: 3000 !important;
    }

    .table > tbody > tr > td {
        vertical-align: middle;
    }

    .badge-soft {
        background: #eef2ff;
        color: #1f2a56;
        border: 1px solid #cdd5ff;
    }

    .total-box {
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 8px 10px;
    }

    .text-muted-small {
        color: #778;
        font-size: 12px;
    }

    .info-section {
        background: #f9f9f9;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }

        .info-section h5 {
            margin-top: 0;
            color: #333;
            font-weight: bold;
        }
</style>

<div class="row" style="margin-top:10px;">
    <div class="col-md-10 col-md-offset-1 col-lg-8 col-lg-offset-2">
        <div class="panel panel-default">
            <div class="panel-heading">
                <strong><i class="glyphicon glyphicon-retweet"></i> Phiếu trả</strong>
            </div>
            <div class="panel-body">

                <!-- ========================= -->
                <!-- THÔNG TIN PHIẾU MƯỢN     -->
                <!-- ========================= -->
                <div class="info-section">
                    <h5><i class="glyphicon glyphicon-info-sign"></i> Thông tin phiếu mượn</h5>
                    <div class="form-horizontal">

                        <div class="form-group">
                            <label class="col-sm-3 control-label">Mã phiếu mượn:</label>
                            <div class="col-sm-4">
                                <input id="rtBorrowId" class="form-control" placeholder="Nhập mã phiếu mượn..." autocomplete="off">
                            </div>

                            <label class="col-sm-2 control-label">Ngày trả:</label>
                            <div class="col-sm-3">
                                <input id="rtReturnDate" type="date" class="form-control">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-3 control-label">Tên độc giả:</label>
                            <div class="col-sm-9">
                                <input id="rtReaderName" class="form-control" readonly>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-3 control-label">Hạn trả:</label>
                            <div class="col-sm-4">
                                <input id="rtDueDate" class="form-control" readonly>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- ========================= -->
                <!-- DANH SÁCH SÁCH TRẢ        -->
                <!-- ========================= -->
                <div class="table-responsive">
                    <table class="table table-bordered" id="tblReturn">
                        <thead>
                            <tr class="active">
                                <th style="width:50px">STT</th>
                                <th style="width:100px">Mã sách</th>
                                <th>Tên sách</th>
                                <th style="width:160px">Tình trạng</th>
                                <th style="width:120px" class="text-right">Phí phạt</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="row" style="margin-top:10px">
                    <div class="col-sm-6 text-muted-small">
                        <span class="badge badge-soft">Quy định trả sách</span>
                        <ul style="margin-top:8px">
                            <li>Trả trễ hạn: <strong>2.000đ/ngày</strong></li>
                            <li>Hư nhẹ: <strong>10.000đ/cuốn</strong></li>
                            <li>Mất sách: <strong>50.000đ/cuốn</strong></li>
                        </ul>
                    </div>

                    <div class="col-sm-6">
                        <div class="total-box">
                            <div>Tổng số sách: <strong id="rtTotalBooks">0</strong></div>
                            <div>Phạt hư/mất: <strong id="rtTotalFine">0đ</strong></div>
                            <div>Phạt trễ hạn: <strong id="rtLateFine">0đ</strong></div>
                            <hr>
                            <div>Tổng cộng phạt: <strong id="rtFinalFine">0đ</strong></div>
                        </div>
                    </div>
                </div>

                <div class="text-right" style="margin-top:12px;">
                    <button class="btn btn-default" id="rtPrint"><i class="glyphicon glyphicon-print"></i> In phiếu</button>
                    <button class="btn btn-primary" id="rtSubmit"><i class="glyphicon glyphicon-ok"></i> Xác nhận trả</button>
                </div>

            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
$(function(){

    const fineDamage = 10000;
    const fineLost = 50000;

    $("#rtReturnDate").val(new Date().toISOString().slice(0, 10));

    // AUTOCOMPLETE
    $("#rtBorrowId").autocomplete({
        source: function(req, res){
            $.ajax({
                url: '@Url.Action("TimPhieuMuon","MuonTra")',
                data: { term: req.term },
                success: function(data){ res(data); }
            });
        },
        minLength: 1,
        select: function(e, ui){
            $("#rtBorrowId").val(ui.item.value);
            loadBookList(ui.item.value);
            return false;
        }

    });

    // Người dùng gõ mã phiếu
    $("#rtBorrowId").on("keyup change", function(){
        let id = $(this).val().trim();
        if(id !== "") loadBookList(id);
    });

    // LOAD SÁCH + độc giả + hạn trả
    function loadBookList(maPhieu){

        $.ajax({
            url: '@Url.Action("LaySachTuPhieuMuon","MuonTra")',
            data: { maPhieu: maPhieu },
            success: function(data){

                if (!data.success){
                    showToast("error","Không tìm thấy phiếu mượn!");
                    return;
                }

                $("#rtReaderName").val(data.reader);
                $("#rtDueDate").val(data.dueDate);

                const tbody = $("#tblReturn tbody").empty();

                data.books.forEach((b, i)=>{
                    tbody.append(`
                        <tr>
                            <td class='text-center'><strong>${i+1}</strong></td>
                            <td>${b.code}</td>
                            <td>${b.title}</td>
                            <td>
                                <select class='form-control input-status'>
                                    <option value='Tốt'>Tốt</option>
                                    <option value='Hư hỏng nhẹ'>Hư hỏng nhẹ</option>
                                    <option value='Mất sách'>Mất sách</option>
                                </select>
                            </td>
                            <td class='text-right'><span class='fine-value'>0</span>đ</td>
                        </tr>
                    `);
                });

                updateTotals();
            }
        });

    }

    // TÍNH TIỀN HƯ HỎNG
    $("#tblReturn").on("change", ".input-status", function(){
        const row = $(this).closest("tr");
        const status = $(this).val();

        let fine = 0;
        if (status === "Hư hỏng nhẹ") fine = fineDamage;
        else if (status === "Mất sách") fine = fineLost;

        row.find(".fine-value").text(fine.toLocaleString());
        updateTotals();
    });

    function updateTotals(){

        $("#rtTotalBooks").text($("#tblReturn tbody tr").length);

        let totalFine = 0;
        $("#tblReturn tbody tr").each(function(){
            totalFine += parseInt($(this).find(".fine-value").text().replace(/\D/g,'')) || 0;
        });

        $("#rtTotalFine").text(totalFine.toLocaleString()+"đ");

        let lateFine = 0;
        const due = $("#rtDueDate").val();
        const ret = $("#rtReturnDate").val();

        if (due && ret){
            const d1 = new Date(due);
            const d2 = new Date(ret);
            if (d2 > d1){
                lateFine = (d2 - d1) / (1000*3600*24) * 2000;
            }
        }

        $("#rtLateFine").text(lateFine.toLocaleString()+"đ");
        $("#rtFinalFine").text((lateFine+totalFine).toLocaleString()+"đ");
    }

    // SUBMIT
    $("#rtSubmit").click(function(){

        const payload = {
            borrowId: $("#rtBorrowId").val(),
            returnDate: $("#rtReturnDate").val(),
            books: []
        };

        $("#tblReturn tbody tr").each(function(){
            payload.books.push({
                code: $(this).find("td:eq(1)").text(),
                status: $(this).find(".input-status").val(),
                fine: parseInt($(this).find(".fine-value").text().replace(/\D/g,'')) || 0
            });
        });

        $.ajax({
            url: '@Url.Action("SavePhieuTra","MuonTra")',
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(payload),
            success: function(res){
                if (res.success) showToast("success",res.message);
                else showToast("error",res.message);
            }
        });

    });


    // ===================================================
    // 🖨  IN PHIẾU TRẢ — FULL CHUẨN MẪU THƯ VIỆN
    // ===================================================
    $("#rtPrint").click(function(){

        let win = window.open("", "_blank", "width=900,height=700");

        let html = `
            <html>
            <head>
                <title>PHIẾU TRẢ SÁCH</title>
                <style>
                    body { font-family: Arial; padding: 20px; }
                    h2 { text-align: center; }
                    table { width:100%; border-collapse: collapse; margin-top:10px; }
                    table, th, td { border:1px solid #000; }
                    th, td { padding:7px; text-align:left; }
                </style>
            </head>

            <body>
                <h2>PHIẾU TRẢ SÁCH</h2>

                <p><strong>Mã phiếu mượn:</strong> ${$("#rtBorrowId").val()}</p>
                <p><strong>Tên độc giả:</strong> ${$("#rtReaderName").val()}</p>
                <p><strong>Hạn trả:</strong> ${$("#rtDueDate").val()}</p>
                <p><strong>Ngày trả:</strong> ${$("#rtReturnDate").val()}</p>

                <h4>Danh sách sách trả:</h4>

                <table>
                    <tr>
                        <th>STT</th>
                        <th>Mã sách</th>
                        <th>Tên sách</th>
                        <th>Tình trạng</th>
                        <th>Phí phạt</th>
                    </tr>
        `;

        $("#tblReturn tbody tr").each(function(i){
            html += `
                <tr>
                    <td>${i+1}</td>
                    <td>${$(this).find("td:eq(1)").text()}</td>
                    <td>${$(this).find("td:eq(2)").text()}</td>
                    <td>${$(this).find(".input-status").val()}</td>
                    <td>${$(this).find(".fine-value").text()}đ</td>
                </tr>
            `;
        });

        html += `
                </table>

                <h3>Tổng tiền phạt: ${$("#rtFinalFine").text()}</h3>

            </body>
            </html>
        `;

        win.document.write(html);
        win.document.close();
        win.print();
    });


    function showToast(type,msg){
        const cls = type==="success"?"alert-success":(type==="error"?"alert-danger":"alert-warning");
        const toast = $(`<div class="alert ${cls} alert-dismissible"
            style="position:fixed;top:20px;right:20px;z-index:9999;min-width:300px;">
            <button type="button" class="close" data-dismiss="alert">&times;</button>${msg}</div>`);
        $("body").append(toast);
        setTimeout(()=>toast.fadeOut(()=>toast.remove()),3000);
    }

});
    </script>
}

}

