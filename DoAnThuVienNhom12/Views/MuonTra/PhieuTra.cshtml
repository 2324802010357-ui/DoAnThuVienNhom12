@{
    ViewBag.Title = "Phiếu trả";
}

<div class="panel panel-default" style="margin-top:10px;">
    <div class="panel-heading"><strong><i class="glyphicon glyphicon-list-alt"></i> Phiếu trả</strong></div>
    <div class="panel-body">

        <div class="form-horizontal">
            <div class="form-group">
                <label class="col-sm-3 control-label">Mã phiếu mượn:</label>
                <div class="col-sm-3"><input id="rtBorrowId" class="form-control" placeholder="VD: PM0001" autocomplete="off" /></div>
                <div class="col-sm-3"><button id="rtLoadBorrow" type="button" class="btn btn-default"><i class="glyphicon glyphicon-search"></i> Tải dữ liệu</button></div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">Độc giả:</label>
                <div class="col-sm-7"><input id="rtReader" class="form-control" disabled placeholder="Tự điền…" /></div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label">Ngày trả:</label>
                <div class="col-sm-3"><input id="rtReturnDate" type="date" class="form-control" /></div>
            </div>
        </div>

        <hr />

        <div class="table-responsive">
            <table class="table table-bordered" id="tblReturn">
                <thead>
                    <tr class="active">
                        <th style="width:40px"><input type="checkbox" id="rtCheckAll" /></th>
                        <th style="width:110px">Mã sách</th>
                        <th>Tên sách</th>
                        <th style="width:120px">Hạn trả</th>
                        <th style="width:110px">Ngày trả</th>
                        <th style="width:90px">Trễ</th>
                        <th style="width:140px">Tình trạng</th>
                        <th style="width:110px">Phí (đ)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="row">
            <div class="col-sm-6" style="color:#778">
                <span class="label label-info">Ghi chú</span>
                <ul style="margin-top:8px">
                    <li>Phạt trễ = trễ ngày × <strong id="feePerDay">2000</strong> đ.</li>
                    <li>Hư nhẹ: +5.000đ; Hư nặng/Mất: +50.000đ (demo).</li>
                </ul>
            </div>
            <div class="col-sm-6">
                <div style="background:#f8fafc;border:1px solid #e5e7eb;border-radius:6px;padding:8px 10px">
                    Tổng tiền phạt: <strong id="rtTotalFee">0</strong> đ
                </div>
            </div>
        </div>

        <div class="text-right" style="margin-top:12px">
            <button class="btn btn-default" type="button" id="rtPrint"><i class="glyphicon glyphicon-print"></i> In phiếu</button>
            <button class="btn btn-primary" type="button" id="rtSubmit"><i class="glyphicon glyphicon-ok"></i> Xác nhận trả</button>
        </div>
    </div>
</div>

@section Scripts{
    <script>
(function(){
  var FEE_PER_DAY=2000; $('#feePerDay').text(FEE_PER_DAY.toLocaleString());
  function todayStr(){return new Date().toISOString().slice(0,10);}
  function addDaysStr(d,days){var x=new Date(d);x.setDate(x.getDate()+days);return x.toISOString().slice(0,10);}
  $('#rtReturnDate').val(todayStr());

  $('#rtCheckAll').on('change', function(){ $('#tblReturn tbody .chk').prop('checked', this.checked).trigger('change'); });

  // DEMO: tải từ mã phiếu mượn
  $('#rtLoadBorrow').on('click', function(){
    var id=$('#rtBorrowId').val().trim(); if(!id){ alert('Nhập mã phiếu mượn'); return; }
    $('#rtReader').val('DG001 • Nguyễn Văn A'); // giả lập
    var due = addDaysStr(todayStr(), 7);
    renderRows([
      {code:'S001', title:'Lập trình C# nâng cao', due: due},
      {code:'S003', title:'Toán cao cấp A1',       due: due}
    ]);
  });

  function renderRows(rows){
    var tb=$('#tblReturn tbody').empty();
    rows.forEach(function(r){
      var tr=$('<tr/>');
      tr.append('<td class="text-center"><input type="checkbox" class="chk"></td>');
      tr.append('<td>'+r.code+'</td>');
      tr.append('<td>'+r.title+'</td>');
      tr.append('<td class="td-due">'+r.due+'</td>');
      tr.append('<td><input type="date" class="form-control in-return" value="'+($('#rtReturnDate').val()||todayStr())+'"></td>');
      tr.append('<td class="td-late text-center">0</td>');
      tr.append('<td><select class="form-control in-cond"><option value="ok">Bình thường</option><option value="light">Hư nhẹ (+5k)</option><option value="heavy">Hư nặng/Mất (+50k)</option></select></td>');
      tr.append('<td class="td-fee text-right">0</td>');
      tb.append(tr);
    });
    recalc();
  }

  function daysBetween(a,b){ return Math.ceil((new Date(a)-new Date(b))/(1000*60*60*24)); }
  function money(n){ return (n||0).toLocaleString(); }

  function recalc(){
    var total=0, ret=$('#rtReturnDate').val()||todayStr();
    $('#tblReturn tbody tr').each(function(){
      var $tr=$(this), due=$tr.find('.td-due').text();
      var actual=$tr.find('.in-return').val()||ret;
      var late=Math.max(0, daysBetween(actual,due));
      $tr.find('.td-late').text(late);

      var fee=late*FEE_PER_DAY, cond=$tr.find('.in-cond').val();
      if(cond==='light') fee+=5000;
      if(cond==='heavy') fee+=50000;
      if($tr.find('.chk').prop('checked')) total+=fee;
      $tr.find('.td-fee').text(money(fee));
    });
    $('#rtTotalFee').text(money(total));
  }

  $('#tblReturn').on('change','.chk,.in-return,.in-cond',recalc);
  $('#rtReturnDate').on('change', function(){ $('#tblReturn tbody .in-return').val(this.value); recalc(); });

  $('#rtPrint').on('click',()=>window.print());
  $('#rtSubmit').on('click',()=>alert('Xác nhận trả & thu: '+$('#rtTotalFee').text()+'đ (demo)'));
})();
    </script>
}
