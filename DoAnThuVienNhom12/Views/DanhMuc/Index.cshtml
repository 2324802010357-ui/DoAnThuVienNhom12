@model IEnumerable<DoAnThuVienNhom12.Models.DanhMucSachModel>

@{
    ViewBag.Title = "Quản lý danh mục";
}

<div class="animate-fade-in">
    <div class="page-header">
        <h2><i class="fa fa-folder-open"></i> @ViewBag.Title</h2>
        <p class="lead">Quản lý thể loại và danh mục sách trong thư viện</p>
    </div>

    <!-- Thanh tìm kiếm và thao tác -->
    <div class="library-card">
        <div class="row">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Tìm kiếm danh mục..." id="searchCategory">
                    <span class="input-group-btn">
                        <button class="btn btn-primary" type="button" id="btnSearchCategory">
                            <i class="fa fa-search"></i>
                        </button>
                    </span>
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-control" id="filterTrangThai">
                    <option value="">Tất cả trạng thái</option>
                    <option value="Hoạt động">Hoạt động</option>
                    <option value="Tạm ngưng">Tạm ngưng</option>
                </select>
            </div>
            <div class="col-md-3 text-right">
                <button class="btn btn-success" data-toggle="modal" data-target="#addCategoryModal">
                    <i class="fa fa-plus"></i> Thêm danh mục
                </button>
            </div>
        </div>
    </div>

    <!-- Thống kê danh mục -->
    <div class="row">
        <div class="col-md-3">
            <div class="library-card text-center">
                <div class="staff-avatar" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                    <i class="fa fa-folder"></i>
                </div>
                <h4>Tổng danh mục</h4>
                <h2 class="text-purple">@(Model?.Count() ?? 0)</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="library-card text-center">
                <div class="staff-avatar" style="background: linear-gradient(135deg, #27ae60, #2ecc71);">
                    <i class="fa fa-check-circle"></i>
                </div>
                <h4>Hoạt động</h4>
                <h2 class="text-success">@(Model?.Count(x => x.TrangThai == "Hoạt động") ?? 0)</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="library-card text-center">
                <div class="staff-avatar" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                    <i class="fa fa-pause-circle"></i>
                </div>
                <h4>Tạm ngưng</h4>
                <h2 class="text-warning">@(Model?.Count(x => x.TrangThai == "Tạm ngưng") ?? 0)</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="library-card text-center">
                <div class="staff-avatar" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                    <i class="fa fa-star"></i>
                </div>
                <h4>Tổng sách</h4>
                <h2 class="text-purple">@(Model?.Sum(x => x.SoLuongSach) ?? 0)</h2>
            </div>
        </div>
    </div>

    <!-- Danh sách danh mục -->
    <div class="library-card">
        <h3 class="section-title">Danh sách danh mục</h3>

        <div id="loadingIndicator" style="display: none; text-align: center; padding: 20px;">
            <i class="fa fa-spinner fa-spin fa-2x"></i>
            <p>Đang tìm kiếm...</p>
        </div>

        <div id="categoryListContainer">
            @Html.Partial("_DanhMucList", Model)
        </div>
    </div>
</div>

<!-- Modal thêm danh mục -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" style="color: white;">&times;</span>
                </button>
                <h4 class="modal-title"><i class="fa fa-plus"></i> Thêm danh mục sách</h4>
            </div>
            <div class="modal-body">
                <form id="addCategoryForm">
                    <div class="form-group">
                        <label>Tên danh mục <span class="text-danger">*</span></label>
                        <input type="text" name="TenDanhMuc" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Mô tả</label>
                        <textarea name="MoTa" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Trạng thái <span class="text-danger">*</span></label>
                        <select name="TrangThai" class="form-control" required>
                            <option value="">-- Chọn trạng thái --</option>
                            <option value="Hoạt động">Hoạt động</option>
                            <option value="Tạm ngưng">Tạm ngưng</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="btnAddCategory">
                    <i class="fa fa-plus"></i> Thêm danh mục
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal sửa danh mục -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #f39c12, #e67e22); color: white;">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true" style="color: white;">&times;</span>
                </button>
                <h4 class="modal-title"><i class="fa fa-edit"></i> Sửa thông tin danh mục</h4>
            </div>
            <div class="modal-body">
                <form id="editCategoryForm">
                    <input type="hidden" name="MaDanhMuc" id="editMaDanhMuc">
                    <div class="form-group">
                        <label>Tên danh mục <span class="text-danger">*</span></label>
                        <input type="text" name="TenDanhMuc" id="editTenDanhMuc" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Mô tả</label>
                        <textarea name="MoTa" id="editMoTa" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Trạng thái <span class="text-danger">*</span></label>
                        <select name="TrangThai" id="editTrangThai" class="form-control" required>
                            <option value="">-- Chọn trạng thái --</option>
                            <option value="Hoạt động">Hoạt động</option>
                            <option value="Tạm ngưng">Tạm ngưng</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-warning" id="btnEditCategory">
                    <i class="fa fa-save"></i> Cập nhật
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {

            // Ngăn cache Ajax
            $.ajaxSetup({ cache: false });

            // =========== 🟩 THÊM DANH MỤC =========== //
            $('#btnAddCategory').click(function () {
                var formData = $('#addCategoryForm').serialize();

                $.post('@Url.Action("ThemDanhMuc", "DanhMuc")', formData, function (res) {
                    if (res.success) {
                        $('#addCategoryModal').modal('hide');
                        showToast('success', res.message);
                        refreshCategoryList();
                        $('#addCategoryForm')[0].reset();
                    } else {
                        showToast('error', res.message);
                    }
                }).fail(function () {
                    showToast('error', 'Không thể thêm danh mục! Vui lòng kiểm tra kết nối.');
                });
            });

            // =========== 🟧 CẬP NHẬT DANH MỤC =========== //
            $('#btnEditCategory').click(function () {
                var formData = $('#editCategoryForm').serialize();

                $.post('@Url.Action("SuaDanhMuc", "DanhMuc")', formData, function (res) {
                    if (res.success) {
                        $('#editCategoryModal').modal('hide');
                        showToast('success', res.message);
                        refreshCategoryList();
                    } else {
                        showToast('error', res.message);
                    }
                }).fail(function () {
                    showToast('error', 'Không thể cập nhật danh mục! Vui lòng thử lại.');
                });
            });

            // =========== 🟥 XÓA DANH MỤC =========== //
            $(document).on('click', '.btn-delete-category', function () {
                var id = $(this).data('category-id');
                var ten = $(this).data('category-name');

                if (!confirm('Bạn có chắc muốn xóa danh mục "' + ten + '" không?')) return;

                $.post('@Url.Action("XoaDanhMuc", "DanhMuc")', { MaDanhMuc: id }, function (res) {
                    if (res.success) {
                        showToast('success', res.message);
                        refreshCategoryList();
                    } else {
                        showToast('error', res.message);
                    }
                }).fail(function () {
                    showToast('error', 'Không thể xóa danh mục! Vui lòng thử lại.');
                });
            });

            // =========== 🟨 SỬA DANH MỤC - NẠP DỮ LIỆU LÊN MODAL =========== //
            $(document).on('click', '.btn-edit-category', function () {
                var id = $(this).data('category-id');

                $.get('@Url.Action("GetDanhMuc", "DanhMuc")', { MaDanhMuc: id }, function (res) {
                    if (res.success) {
                        $('#editMaDanhMuc').val(res.data.MaDanhMuc);
                        $('#editTenDanhMuc').val(res.data.TenDanhMuc);
                        $('#editMoTa').val(res.data.MoTa);
                        $('#editTrangThai').val(res.data.TrangThai);

                        $('#editCategoryModal').modal('show');
                    } else {
                        showToast('error', res.message);
                    }
                }).fail(function () {
                    showToast('error', 'Không thể tải dữ liệu danh mục!');
                });
            });

            // =========== 🔄 LÀM MỚI DANH SÁCH =========== //
            function refreshCategoryList() {
                $('#loadingIndicator').show();
                $.post('@Url.Action("TimKiemDanhMuc", "DanhMuc")', {}, function (html) {
                    $('#categoryListContainer').html(html);
                }).always(function () {
                    $('#loadingIndicator').hide();
                });
            }

            // =========== 🔍 TÌM KIẾM DANH MỤC =========== //
            $('#btnSearchCategory, #filterTrangThai').on('click change', function () {
                searchCategory();
            });

            $('#searchCategory').on('keypress', function (e) {
                if (e.which === 13) searchCategory();
            });

            function searchCategory() {
                var keyword = $('#searchCategory').val();
                var status = $('#filterTrangThai').val();

                $('#loadingIndicator').show();
                $.post('@Url.Action("TimKiemDanhMuc", "DanhMuc")',
                    { searchTerm: keyword, trangThai: status },
                    function (html) {
                        $('#categoryListContainer').html(html);
                    }).always(function () {
                        $('#loadingIndicator').hide();
                    });
            }

            // =========== 🔔 TOAST THÔNG BÁO =========== //
            function showToast(type, message) {
                var cls = type === 'success' ? 'alert-success' :
                          type === 'error' ? 'alert-danger' : 'alert-warning';
                var toast = $(
                    '<div class="alert ' + cls + ' alert-dismissible fade in" ' +
                    'style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">' +
                    '<button type="button" class="close" data-dismiss="alert">&times;</button>' +
                    '<strong>' + message + '</strong></div>'
                );
                $('body').append(toast);
                setTimeout(() => toast.alert('close'), 3000);
            }
        });
    </script>
}

