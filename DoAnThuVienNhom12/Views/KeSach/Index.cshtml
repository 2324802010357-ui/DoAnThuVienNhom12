@model IEnumerable<DoAnThuVienNhom12.Models.KeSach>

@{
    ViewBag.Title = "Quản lý kệ sách";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .shelf-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 20px;
        transition: all 0.3s;
    }

        .shelf-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

    .shelf-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .shelf-section {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        background: #f9f9f9;
    }

    .capacity-bar {
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 5px;
    }

    .capacity-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #27ae60, #2ecc71);
        transition: width 0.3s;
    }

        .capacity-bar-fill.warning {
            background: linear-gradient(90deg, #f39c12, #e67e22);
        }

        .capacity-bar-fill.danger {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
        }

    .modal-header-custom {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 6px 6px 0 0;
    }
</style>

<div class="animate-fade-in">
    <div class="page-header">
        <h2><i class="fa fa-th"></i> Quản lý kệ sách</h2>
        <p class="lead">Tổ chức và quản lý vị trí sách trong thư viện</p>
    </div>

    <div class="row">
        <div class="col-md-8">
            <!-- Danh sách kệ -->
            <div class="shelf-card">
                <div class="row">
                    <div class="col-md-6">
                        <h3><i class="fa fa-list"></i> Danh sách kệ sách</h3>
                    </div>
                    <div class="col-md-6 text-right">
                        <button class="btn btn-success" data-toggle="modal" data-target="#addShelfModal">
                            <i class="fa fa-plus"></i> Thêm kệ mới
                        </button>
                    </div>
                </div>
                <hr />

                @if (Model != null && Model.Any())
                {
                    foreach (var ke in Model)
                    {
                        var usagePercent = ke.SucChua == 0 ? 0 : (int)(((double)ke.SoLuongHienTai / ke.SucChua) * 100);
                        var shelfBarClass = usagePercent > 90 ? "danger" : usagePercent > 75 ? "warning" : "";

                        <div class="shelf-section">
                            <div class="shelf-header">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div>
                                        <h4 style="margin:0;"><i class="fa fa-th"></i> @ke.TenKe</h4>
                                        <small>@ke.ViTri</small>
                                    </div>
                                    <div><span class="label label-default">#@ke.MaKe</span></div>
                                </div>
                            </div>

                            <p><b>Kho:</b> @ke.Kho.TenKho</p>
                            <p><b>Sức chứa:</b> @ke.SucChua | <b>Hiện tại:</b> @ke.SoLuongHienTai (@usagePercent%)</p>

                            <div class="capacity-bar">
                                <div class="capacity-bar-fill @shelfBarClass" style="width:@usagePercent%"></div>
                            </div>

                            <div class="text-right" style="margin-top:10px;">
                                <a href="@Url.Action("Detail","KeSach", new { id = ke.MaKe })" class="btn btn-primary btn-sm">
                                    <i class="fa fa-eye"></i> Chi tiết
                                </a>
                                <button class="btn btn-warning btn-sm btn-edit"
                                        data-id="@ke.MaKe"
                                        data-tenke="@ke.TenKe"
                                        data-makho="@ke.MaKho"
                                        data-vitri="@ke.ViTri"
                                        data-succhua="@ke.SucChua">
                                    <i class="fa fa-edit"></i> Sửa
                                </button>
                                <button class="btn btn-danger btn-sm btn-delete" data-id="@ke.MaKe">
                                    <i class="fa fa-trash"></i> Xóa
                                </button>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <p class="text-center text-muted">Chưa có kệ nào được thêm.</p>
                }
            </div>
        </div>

        <div class="col-md-4">
            <!-- Thống kê -->
            <div class="shelf-card">
                <h4><i class="fa fa-chart-bar"></i> Thống kê tổng</h4>
                <hr />
                <p><b>Tổng số kệ:</b> @Model.Count()</p>
                <p><b>Tổng sức chứa:</b> @Model.Sum(k => k.SucChua)</p>
                <p><b>Đã sử dụng:</b> @Model.Sum(k => k.SoLuongHienTai)</p>

                @{
                    var totalCapacity = Model.Sum(k => k.SucChua);
                    var totalUsed = Model.Sum(k => k.SoLuongHienTai);
                    var percent = totalCapacity == 0 ? 0 : (int)(((double)totalUsed / totalCapacity) * 100);
                    var totalBarClass = percent > 90 ? "danger" : percent > 75 ? "warning" : "";
                }
                <div class="capacity-bar">
                    <div class="capacity-bar-fill @totalBarClass" style="width:@percent%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Thêm Kệ -->
<div class="modal fade" id="addShelfModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <button type="button" class="close" data-dismiss="modal" style="color:white;">
                    <span>&times;</span>
                </button>
                <h4 class="modal-title"><i class="fa fa-plus"></i> Thêm kệ sách mới</h4>
            </div>
            <div class="modal-body">
                <form id="addShelfForm">
                    <div class="form-group">
                        <label>Tên kệ <span class="text-danger">*</span></label>
                        <input type="text" name="TenKe" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label>Kho chứa <span class="text-danger">*</span></label>
                        <select name="MaKho" class="form-control">
                            @foreach (var kho in ViewBag.KhoList as List<DoAnThuVienNhom12.Models.Kho>)
                            {
                                <option value="@kho.MaKho">@kho.TenKho</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Vị trí</label>
                        <input type="text" name="ViTri" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label>Sức chứa</label>
                        <input type="number" name="SucChua" class="form-control" min="1" value="50" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Hủy</button>
                <button type="button" id="btnSaveShelf" class="btn btn-primary">
                    <i class="fa fa-save"></i> Lưu
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Sửa Kệ -->
<div class="modal fade" id="editShelfModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <button type="button" class="close" data-dismiss="modal" style="color:white;">
                    <span>&times;</span>
                </button>
                <h4 class="modal-title"><i class="fa fa-edit"></i> Sửa thông tin kệ</h4>
            </div>
            <div class="modal-body">
                <form id="editShelfForm">
                    <input type="hidden" name="MaKe" />
                    <div class="form-group">
                        <label>Tên kệ</label>
                        <input type="text" name="TenKe" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label>Kho chứa</label>
                        <select name="MaKho" class="form-control">
                            @foreach (var kho in ViewBag.KhoList as List<DoAnThuVienNhom12.Models.Kho>)
                            {
                                <option value="@kho.MaKho">@kho.TenKho</option>
                            }
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Vị trí</label>
                        <input type="text" name="ViTri" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label>Sức chứa</label>
                        <input type="number" name="SucChua" class="form-control" min="1" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Hủy</button>
                <button type="button" id="btnUpdateShelf" class="btn btn-primary">
                    <i class="fa fa-save"></i> Cập nhật
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ============= Thêm kệ =============
        $('#btnSaveShelf').on('click', function () {
            var data = $('#addShelfForm').serialize();
            $.post('/KeSach/ThemKe', data, function (res) {
                alert(res.message);
                if (res.success) location.reload();
            });
        });

        // ============= Mở modal Sửa =============
        $('.btn-edit').on('click', function () {
            var id = $(this).data('id');
            $('#editShelfForm [name="MaKe"]').val(id);
            $('#editShelfForm [name="TenKe"]').val($(this).data('tenke'));
            $('#editShelfForm [name="MaKho"]').val($(this).data('makho'));
            $('#editShelfForm [name="ViTri"]').val($(this).data('vitri'));
            $('#editShelfForm [name="SucChua"]').val($(this).data('succhua'));
            $('#editShelfModal').modal('show');
        });

        // ============= Cập nhật kệ =============
        $('#btnUpdateShelf').on('click', function () {
            var data = $('#editShelfForm').serialize();
            $.post('/KeSach/SuaKe', data, function (res) {
                alert(res.message);
                if (res.success) location.reload();
            });
        });

        // ============= Xóa kệ =============
        $('.btn-delete').on('click', function () {
            var id = $(this).data('id');
            if (confirm('Bạn có chắc muốn xóa kệ này?')) {
                $.post('/KeSach/XoaKe', { MaKe: id }, function (res) {
                    alert(res.message);
                    if (res.success) location.reload();
                });
            }
        });
    </script>
}
